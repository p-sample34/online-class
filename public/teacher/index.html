<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Teacher Panel | Online Test</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background:#f7f7f7; }
    .container{ max-width:800px; margin:0 auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.08); }
    textarea, input { width:100%; padding:10px; margin:8px 0; box-sizing:border-box; }
    button { padding:10px 14px; margin-top:8px; cursor:pointer; }
    .answer-card{ border:1px solid #eee; padding:10px; margin:10px 0; border-radius:6px; background:#fafafa; }
    #rankBox { margin-top:20px; padding:10px; background:#eef9ff; border-radius:6px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ‘©â€ğŸ« Teacher Panel</h1>

    <section>
      <h3>Send Question</h3>
      <textarea id="questionInput" rows="3" placeholder="Type question..."></textarea>
      <input id="timeLimit" type="number" placeholder="Time limit (seconds)" />
      <button id="sendBtn">Send Question</button>
      <p id="sendStatus" style="color:green;"></p>
    </section>

    <hr/>

    <section>
      <h3>Live Answers</h3>
      <div id="answersContainer"></div>
    </section>

    <button id="generateRanks">Generate Ranks ğŸ†</button>
    <div id="rankBox" style="display:none;"></div>

    <br>
    <button id="exportPDF">Export PDF ğŸ“„</button>

  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    (function(){
      const API_URL = "https://online-class-m8h6.onrender.com";
      const socket = io(API_URL);

      let currentQuestion = "";

      const questionInput = document.getElementById("questionInput");
      const timeLimitInput = document.getElementById("timeLimit");
      const answersContainer = document.getElementById("answersContainer");
      const rankBox = document.getElementById("rankBox");

      document.getElementById("sendBtn").addEventListener("click", async () => {
        const question = questionInput.value.trim();
        const timeLimit = timeLimitInput.value.trim();
        if(!question || !timeLimit) return alert("Enter question & time limit");

        const res = await fetch(`${API_URL}/teacher/add-question`, {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body:JSON.stringify({ question, timeLimit })
        });
        const q = await res.json();

        currentQuestion = q.question;

        socket.emit("teacher-question", {
          question: q.question,
          timeLimit: q.timeLimit,
          questionId: q._id
        });

        questionInput.value = "";
        timeLimitInput.value = "";
        document.getElementById("sendStatus").innerText = "âœ… Sent!";
      });

      socket.on("student-answer", ({ studentName, answer, questionId }) => {
        addAnswerCard(studentName, answer, questionId);
      });

      function addAnswerCard(studentName, answer, questionId){
        const div = document.createElement("div");
        div.className = "answer-card";

        div.innerHTML = `
          <b>${studentName}</b>
          <p>${answer}</p>
          <input type="number" placeholder="Marks" class="mark-input">
          <button class="mark-btn">Submit Marks</button>
        `;

        div.querySelector(".mark-btn").onclick = async () => {
          const marks = div.querySelector(".mark-input").value;
          if(marks==="") return alert("Enter marks first");

          const res = await fetch(`${API_URL}/teacher/mark-answer`, {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body:JSON.stringify({ studentName, questionId, marks })
          });

          const r = await res.json();
          if(r.success){
            div.querySelector(".mark-btn").innerText="âœ… Saved";
            div.querySelector(".mark-btn").disabled=true;
            div.querySelector(".mark-input").disabled=true;
          }
        };

        answersContainer.prepend(div);
      }

      document.getElementById("generateRanks").onclick = () => {
        const results = [...document.querySelectorAll(".answer-card")].map(card => {
          return {
            name: card.querySelector("b").innerText,
            marks: parseFloat(card.querySelector(".mark-input")?.value || 0)
          };
        }).sort((a,b)=> b.marks-a.marks);

        rankBox.style.display="block";
        rankBox.innerHTML = "<h3>ğŸ† Rank List</h3>" + results.map((r,i)=>`${i+1}. ${r.name} - ${r.marks}`).join("<br>");
      };

      document.getElementById("exportPDF").onclick = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const filename = currentQuestion
          ? currentQuestion.substring(0,20).replace(/[^a-zA-Z0-9]/g,"_") + "_" + new Date().toLocaleDateString() + ".pdf"
          : "student_results.pdf";

        doc.setFontSize(15);
        doc.text("Student Responses Report", 10, 15);

        if(currentQuestion){
          doc.text("Question: " + currentQuestion, 10, 25);
        }

        let y = 40;

        const data = [...document.querySelectorAll(".answer-card")].map(card => {
          return {
            name: card.querySelector("b").innerText,
            answer: card.querySelector("p").innerText,
            marks: parseFloat(card.querySelector(".mark-input")?.value || 0)
          };
        }).sort((a,b)=> b.marks-a.marks);

        data.forEach((d,i)=>{
          doc.text(`${i+1}. ${d.name} | Marks: ${d.marks}`, 10, y);
          y+=7;
          doc.text("Answer: " + d.answer, 10, y);
          y+=12;
          if(y > 270){ doc.addPage(); y = 20; }
        });

        doc.save(filename);
      };

    })();
  </script>
</body>
</html>
