<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Teacher Panel | Online Test</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background:#f7f7f7; }
    .container{ max-width:800px; margin:0 auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.08); }
    textarea, input { width:100%; padding:10px; margin:8px 0; box-sizing:border-box; }
    button { padding:10px 14px; margin-top:8px; cursor:pointer; }
    .answer-card{ border:1px solid #eee; padding:10px; margin:10px 0; border-radius:6px; background:#fafafa; }
    #rankBox { margin-top:20px; padding:10px; background:#eef9ff; border-radius:6px; }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ‘©â€ğŸ« Teacher Panel</h1>

    <section>
      <h3>Send Question</h3>
      <textarea id="questionInput" rows="3" placeholder="Type question..."></textarea>
      <input id="timeLimit" type="number" placeholder="Time limit (seconds)" />
      <button id="sendBtn">Send Question</button>
      <p id="sendStatus" style="color:green;"></p>
    </section>

    <hr/>

    <section>
      <h3>Live Answers</h3>
      <div id="answersContainer"></div>
    </section>

    <button id="generateRanks">Generate Ranks ğŸ†</button>
    <div id="rankBox" style="display:none;"></div>

    <br><br>
    <button id="exportPDF">Export PDF ğŸ“„</button>

  </div>

  <!-- SOCKET + PDF LIBRARIES -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
(function(){
  const API_URL = "https://online-class-m8h6.onrender.com";
  const socket = io(API_URL);

  let currentQuestion = "";
  let testName = "Untitled Test";

  const questionInput = document.getElementById("questionInput");
  const timeLimitInput = document.getElementById("timeLimit");
  const answersContainer = document.getElementById("answersContainer");
  const rankBox = document.getElementById("rankBox");

  /* ----------------------- SEND QUESTION ----------------------- */
  document.getElementById("sendBtn").addEventListener("click", async () => {
    const question = questionInput.value.trim();
    const timeLimit = timeLimitInput.value.trim();
    if(!question || !timeLimit) return alert("Enter question & time limit");

    const namePrompt = prompt("Enter Test Name:");
    if(namePrompt) testName = namePrompt;

    const res = await fetch(`${API_URL}/teacher/add-question`, {
      method:"POST", headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ question, timeLimit })
    });
    const q = await res.json();

    currentQuestion = q.question;

    socket.emit("teacher-question", {
      question: q.question,
      timeLimit: q.timeLimit,
      questionId: q._id
    });

    questionInput.value = "";
    timeLimitInput.value = "";
    document.getElementById("sendStatus").innerText = "âœ… Sent!";
  });

  /* ----------------------- RECEIVE STUDENT ANSWER ----------------------- */
  socket.on("student-answer", ({ studentName, answer, questionId }) => {
    addAnswerCard(studentName, answer, questionId);
  });

  function addAnswerCard(studentName, answer, questionId){
    const div = document.createElement("div");
    div.className = "answer-card";

    div.innerHTML = `
      <b>${studentName}</b>
      <p>${answer}</p>
      <input type="number" placeholder="Marks" class="mark-input">
      <button class="mark-btn">Submit Marks</button>
    `;

    div.querySelector(".mark-btn").onclick = async () => {
      const marks = div.querySelector(".mark-input").value;
      if(marks==="") return alert("Enter marks first");

      const res = await fetch(`${API_URL}/teacher/mark-answer`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ studentName, questionId, marks })
      });

      const r = await res.json();
      if(r.success){
        div.querySelector(".mark-btn").innerText="âœ… Saved";
        div.querySelector(".mark-btn").disabled=true;
        div.querySelector(".mark-input").disabled=true;
      }
    };

    answersContainer.prepend(div);
  }

  /* ----------------------- GENERATE RANKS ----------------------- */
  document.getElementById("generateRanks").onclick = () => {
    const cards = [...document.querySelectorAll(".answer-card")];
    const combined = {};

    cards.forEach(card => {
      const name = card.querySelector("b").innerText;
      const marks = parseFloat(card.querySelector(".mark-input")?.value || 0);
      if(!combined[name]) combined[name] = 0;
      combined[name] += marks;
    });

    const results = Object.entries(combined)
      .map(([name, total]) => ({ name, total }))
      .sort((a,b)=> b.total - a.total);

    rankBox.style.display="block";
    rankBox.innerHTML = "<h3>ğŸ† Rank List</h3>" +
      results.map((r,i)=>`${i+1}. ${r.name} - ${r.total}`).join("<br>");
  };

  /* ----------------------- EXPORT PDF WITH LOGO + TITLE ----------------------- */
  document.getElementById("exportPDF").onclick = async () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    /* ------------------- LOGO URL ------------------- */
    const logoURL = "https://ik.imagekit.io/eycpqxm26/cropped_circle_image.png"; // REPLACE WITH YOUR LOGO

    // Convert image to Base64
    const imgData = await fetch(logoURL).then(r => r.blob()).then(blob => {
      return new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(blob);
      });
    });

    /* ------------------- HEADER ---------------------- */
    doc.addImage(imgData, "PNG", 10, 10, 25, 25);  // Logo left side

    doc.setFontSize(18);
    doc.text("SSVT Online Test Report", 40, 18);

    doc.setFontSize(13);
    doc.text("Date: " + new Date().toLocaleDateString(), 150, 18);

    doc.setFontSize(14);
    doc.text("Test Name: " + testName, 40, 30);

    doc.line(10, 40, 200, 40); // separator

    let y = 50;

    /* ------------------- GROUP ANSWERS ------------------- */
    const grouped = {};

    [...document.querySelectorAll(".answer-card")].forEach(card => {
      const name = card.querySelector("b").innerText;
      const answer = card.querySelector("p").innerText;
      const marks = parseFloat(card.querySelector(".mark-input")?.value || 0);

      if(!grouped[name]) grouped[name] = [];
      grouped[name].push({ question: currentQuestion, answer, marks });
    });

    /* ------------------- PRINTING STUDENT REPORTS ------------------- */
    Object.keys(grouped).forEach((name, index) => {
      const studentAnswers = grouped[name];
      const totalMarks = studentAnswers.reduce((a,b)=>a+b.marks,0);

      doc.setFontSize(15);
      doc.text(`${index+1}) ${name}  | Total Marks: ${totalMarks}`, 10, y);
      y += 10;

      studentAnswers.forEach((qa, i) => {
        // Question
        const qLines = doc.splitTextToSize(`Q${i+1}: ${qa.question}`, 180);
        doc.setFontSize(12);
        doc.text(qLines, 10, y);
        y += qLines.length * 7;

        // Answer
        const aLines = doc.splitTextToSize(`Answer: ${qa.answer}`, 180);
        doc.text(aLines, 10, y);
        y += aLines.length * 7;

        // Marks
        doc.text(`Marks: ${qa.marks}`, 10, y);
        y += 10;

        if(y > 270){ doc.addPage(); y = 20; }
      });

      doc.line(10, y, 200, y);
      y += 10;

      if(y > 270){ doc.addPage(); y = 20; }
    });

    doc.save("SSVT_Report.pdf");
  };

})();
</script>

