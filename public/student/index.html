<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Panel | Online Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { font-family: Arial, sans-serif; background:#f2f2f2; padding:20px; }
  .box { max-width:700px; margin:0 auto; background:#fff; padding:20px;
         border-radius:8px; box-shadow:0 6px 14px rgba(0,0,0,0.1); }
  textarea, input { width:100%; padding:10px; margin:8px 0; }
  button { padding:10px 14px; cursor:pointer; }
  #timer { font-size:20px; font-weight:bold; color:red; }
</style>
</head>
<body>

<div class="box">
  <h2>üßë‚Äçüéì Student Panel</h2>

  <h3>Question</h3>
  <p id="questionBox">Waiting for teacher...</p>

  <p id="timer"></p>

  <textarea id="answerInput" rows="4" placeholder="Write your answer"></textarea>
  <button id="sendAnswer">Submit Answer</button>

  <p id="status" style="color:green;"></p>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
(function(){
  const API_URL = "https://online-class-m8h6.onrender.com";
  const socket = io(API_URL);

  const questionBox = document.getElementById("questionBox");
  const timerBox = document.getElementById("timer");
  const answerInput = document.getElementById("answerInput");

  let currentEndTime = null;

  /* ---------------------------------------
       RECEIVE QUESTION FROM TEACHER
  -----------------------------------------*/
  socket.on("new-question", data => {
    const { question, timeLimit, questionId } = data;

    questionBox.innerText = question;

    // Save to localStorage
    localStorage.setItem("activeQuestion", question);
    localStorage.setItem("activeQuestionId", questionId);

    // Timer end
    const endTime = Date.now() + (timeLimit * 1000);
    localStorage.setItem("endTime", endTime);

    startTimer(endTime);
  });

  /* ---------------------------------------
        RESTORE QUESTION AFTER REFRESH
  -----------------------------------------*/
  window.onload = () => {
    const savedQ = localStorage.getItem("activeQuestion");
    const savedEnd = localStorage.getItem("endTime");

    if(savedQ && savedEnd && Date.now() < savedEnd){
      questionBox.innerText = savedQ;
      startTimer(savedEnd);
    } else {
      clearStoredQuestion();
    }
  };

  /* ---------------------------------------
                TIMER SYSTEM
  -----------------------------------------*/
  function startTimer(endTime){
    currentEndTime = endTime;

    const interval = setInterval(() => {
      let diff = endTime - Date.now();
      if(diff <= 0){
        timerBox.innerText = "‚õî Time Over";
        clearInterval(interval);
        clearStoredQuestion();
        questionBox.innerText = "Time Over";
        answerInput.disabled = true;
        return;
      }

      const sec = Math.floor(diff / 1000);
      timerBox.innerText = "‚è≥ Time Left: " + sec + "s";

    }, 1000);
  }

  function clearStoredQuestion(){
    localStorage.removeItem("activeQuestion");
    localStorage.removeItem("activeQuestionId");
    localStorage.removeItem("endTime");
  }

  /* ---------------------------------------
                SUBMIT ANSWER
  -----------------------------------------*/
  document.getElementById("sendAnswer").onclick = async () => {
    const answer = answerInput.value.trim();
    if(!answer) return alert("Write your answer!");

    const qId = localStorage.getItem("activeQuestionId");

    const res = await fetch(`${API_URL}/student/send-answer`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        studentName: prompt("Enter your name"),
        answer,
        questionId: qId
      })
    });

    const r = await res.json();
    if(r.success){
      document.getElementById("status").innerText = "Answer Submitted!";
      answerInput.value = "";
    }
  };

})();
</script>

</body>
</html>
